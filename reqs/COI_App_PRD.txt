Product Requirements Document (PRD)
Conflict of Interest (COI) Web Application
Owner: Frederik Koetje
Date: Oct 27, 2025

== Scope & Summary ==
A Clean Architecture web app with a React SPA front-end, ASP.NET Core (.NET 8) API, and Azure SQL.
Authentication via Okta (OIDC, PKCE). Hosted on Azure App Services (Linux), optionally fronted by Azure Front Door + WAF.
The app digitizes annual/periodic Conflict of Interest disclosures for Employees and Board Directors, with a Legal WYSIWYG
builder for configurable questionnaires, conditional logic, and a review workflow.

== Tech Stack Summary ==
[Frontend]
- React 18 + TypeScript 5 (Vite), React Router v6
- @tanstack/react-query; Zustand (or Redux Toolkit)
- React Hook Form + Zod
- Okta OIDC — @okta/okta-react, @okta/okta-auth-js (Authorization Code with PKCE)
- Tailwind CSS + Radix UI / shadcn/ui
- Fetch/Axios interceptor (Bearer, 401 renew)
- Testing: Vitest, React Testing Library, Playwright
- API typing: openapi-typescript (or orval)

[Backend / API]
- .NET 8 — ASP.NET Core Web API
- Clean Architecture (Domain, Application, Infrastructure, API)
- CQRS/Mediator: MediatR; Validation: FluentValidation (pipeline)
- Mapping: AutoMapper; Resilience: Polly
- AuthN/AuthZ: JWT Bearer (Okta OIDC) + policy-based authorization (scopes/roles)
- API Versioning: Asp.Versioning.Http; Docs: Swashbuckle/NSwag (OAuth2/PKCE)
- Logging/Tracing: Serilog + Application Insights

[Data]
- Azure SQL Database; EF Core 8 (code-first migrations in Infrastructure)
- Optional Outbox table for reliable events

[Azure Hosting & Cloud]
- Azure App Service (Linux): separate apps for SPA and API
- Azure Front Door + WAF (custom domains, TLS, caching)
- Azure Key Vault (secrets; API via Managed Identity)
- Azure Application Insights + Log Analytics (traces, metrics, dashboards)
- Azure App Configuration (feature flags)
- Azure Cache for Redis (optional); WebJobs/Azure Functions (optional background/outbox)

[Security & Auth (Okta)]
- Okta SPA app (OIDC): Authorization Code with PKCE (no client secret in browser)
- Tokens in memory/session; Access Token used for API calls
- API validates issuer/audience/JWKS; checks scopes/roles
- Strict CORS (SPA origin only); strong CSP; no secrets in client bundle

== Architecture (Clean Architecture) ==
- Domain: Entities, Value Objects, Domain Services, Domain Events (no external deps)
- Application: Use cases (MediatR), DTOs, validators, mapping; depends only on Domain
- Infrastructure: EF Core, repository implementations, external adapters; implements Application ports
- API (Presentation): ASP.NET Core endpoints, auth, ProblemDetails, DI composition root
- Dependency rule: Client -> API -> Application -> Domain; Infrastructure referenced only by API for DI

== Features — Conflict of Interest (COI) ==

[Roles & Permissions]
- Employee/Director: complete forms, save draft, submit, view history, upload docs, e-sign
- Legal Admin: WYSIWYG builder, answer types, branching, versioning, assign, review, export
- Reviewer: queue processing, comments, approvals, flags
- System Admin: SSO, environment settings, integrations, audit log access

[Question Architecture]
- Two baseline sets: Employees COI, Board COI
- Answer types: Yes/No; Short/Long Text; Yes/No + Conditional Text; Single/Multi Select; Date; Number; File Upload; Attestation
- Conditional logic: IF/THEN branches; role-based visibility; section gating
- Validation: required, regex, length, numeric ranges, file type/size
- Metadata: help text, tags, localization keys, required?, defaults

[Legal WYSIWYG Question Builder]
- Rich editor for question/help text; variables ({{CompanyName}})
- Answer type picker + constraints; drag & drop ordering; visual branching designer
- Versioning: Draft -> Preview -> Publish (published is immutable); clone templates
- Preview as Employee/Board; mobile/desktop preview; test answers for branch coverage

[Assignment & Scheduling]
- Audiences: Employees (HRIS sync), Board (directory/manual)
- Cycles: Annual (default), ad-hoc, off-cycle (on-hire/role change)
- Due dates & reminders; overdue escalations; optional delegation

[Respondent Experience]
- Sectioned wizard with progress; autosave drafts; resume later
- Attachments with validation; final attestation & e-sign
- Accessibility: WCAG 2.1 AA; mobile-friendly

[Review & Decision Workflow]
- Queue: New -> In Review -> Info Requested -> Resubmitted -> Approved/Closed
- Auto-flag rules; threaded comments; decisions with mitigation notes
- Audit trail: every action logged; immutable submission snapshot; PDF export

[Reporting & Exports]
- Dashboards: completion, overdue, flagged trends
- Filters & search; CSV/XLSX exports; PDF submission packages
- Retention policies; legal hold support

[Integrations]
- Okta SSO (roles via groups/claims)
- Email via Azure Communication Services or SendGrid
- HRIS sync (optional); attachments in Azure Blob Storage (SAS links)

[Security & Compliance]
- Role/claim-based authorization; least privilege
- PII handling; encryption at rest/in transit; append-only audit log
- Managers see status only (default), not answers
- Rate limiting; file upload validation; optional AV scan

[Data Model (Initial Draft)]
- QuestionSet(Id, Name, AudienceType, Version, Status, CreatedBy, CreatedAt)
- Section(Id, QuestionSetId, Order, Title, Description)
- Question(Id, SectionId, Order, TextHtml, HelpHtml, Type, Required, ConstraintsJson, Tags, VisibilityRuleJson)
- Option(Id, QuestionId, Value, Label, Order)
- BranchRule(Id, SourceQuestionId, Operator, Value, Action, TargetQuestionId|TargetSectionId)
- Assignment(Id, UserId, QuestionSetId, CycleId, DueDate, Status)
- Submission(Id, AssignmentId, SubmittedAt, SubmittedBy, AttestationText, Signature, IpAddress)
- Answer(Id, SubmissionId, QuestionId, ValueJson)
- Review(Id, SubmissionId, Status, ReviewerId, Notes, CreatedAt)
- Comment(Id, SubmissionId, AuthorId, Body, CreatedAt)
- Attachment(Id, SubmissionId, QuestionId?, BlobUrl, FileName, Size, ContentType, VirusScanStatus)
- AuditEvent(Id, ActorId, Entity, EntityId, Action, PayloadJson, CreatedAt)

[Key User Stories & Acceptance Criteria]
- Create Yes/No + conditional text question; preview shows follow-up on Yes; save as Draft
- Publish set: Draft -> Published (immutable), versioned; assignments can target that version
- Respondent completes & certifies COI; immutable snapshot with timestamp and IP
- Auto-flagged submission moves to Review; clarification request notifies respondent; resubmission tracked
- Reorder questions in Draft; rules reference IDs (not order); preview reflects new order
- New version does not affect old submissions; historical rendering stays accurate

[Non-Functional Requirements (Feature Layer)]
- Performance: <300 ms p95 API; <2 s initial SPA load on 4G
- Scale: 10k+ users per cycle; robust autosave (<=10s)
- Reliability: resume after network drop; thorough validation and error feedback
